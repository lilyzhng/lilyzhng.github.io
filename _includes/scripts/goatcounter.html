{%- if site.goatcounter.site_id -%}
<!-- GoatCounter Analytics - Privacy-friendly website analytics -->
<script data-goatcounter="https://{{ site.goatcounter.site_id }}.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>

{%- if site.goatcounter.show_count -%}
<!-- Display visitor count -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Function to update all visitor counters on the page
  function updateVisitorCount() {
    // Create a temporary element for GoatCounter to inject the count
    var tempDiv = document.createElement('div');
    tempDiv.style.display = 'none';
    tempDiv.id = 'gc-counter';
    document.body.appendChild(tempDiv);
    
    // Wait for GoatCounter to load
    var checkInterval = setInterval(function() {
      if (typeof window.goatcounter !== 'undefined' && window.goatcounter.count) {
        clearInterval(checkInterval);
        
        // Use GoatCounter's visit_count method
        if (window.goatcounter.visit_count) {
          window.goatcounter.visit_count({
            append: '#gc-counter',
            path: window.location.pathname
          });
          
          // Wait a bit for the count to be injected
          setTimeout(function() {
            var countElement = document.querySelector('#gc-counter');
            if (countElement && countElement.textContent) {
              // Extract the number from GoatCounter's output
              var match = countElement.textContent.match(/(\d+)/);
              if (match) {
                var count = parseInt(match[1]);
                // Update all visitor counter elements
                document.querySelectorAll('.goatcounter-visitors').forEach(function(elem) {
                  elem.innerHTML = 'page view: ' + count.toLocaleString();
                });
              }
            }
            // Clean up
            if (countElement) {
              countElement.remove();
            }
          }, 500);
        }
      }
    }, 100);
    
    // Timeout fallback
    setTimeout(function() {
      clearInterval(checkInterval);
      // If still loading, try direct API call
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://{{ site.goatcounter.site_id }}.goatcounter.com/counter/' + encodeURIComponent(window.location.pathname) + '.json');
      xhr.onload = function() {
        if (xhr.status === 200) {
          try {
            var data = JSON.parse(xhr.responseText);
            var count = data.count || data.count_unique || 0;
            document.querySelectorAll('.goatcounter-visitors').forEach(function(elem) {
              elem.innerHTML = 'page view: ' + count.toLocaleString();
            });
          } catch (e) {
            // If JSON fails, show a simple message
            document.querySelectorAll('.goatcounter-visitors').forEach(function(elem) {
              elem.innerHTML = 'page view: -';
            });
          }
        }
      };
      xhr.send();
    }, 3000);
  }
  
  // Run the update
  updateVisitorCount();
});
</script>
{%- endif -%}
{%- endif -%}